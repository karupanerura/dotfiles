#!/bin/sh
set -e
# set -x

URL=$1
OUT=$2
CACHE_DIR="/tmp/git-repo-cache/$URL"

[[ -z "$OUT"     ]] && OUT=`basename $URL | sed -e 's/\.git$//'`
[[ -d $CACHE_DIR ]] || git clone --bare $URL $CACHE_DIR

git --git-dir=$CACHE_DIR fetch
git clone $CACHE_DIR $OUT
git --git-dir=$OUT/.git remote set-url origin $URL